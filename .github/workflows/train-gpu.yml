name: Train on CPU

on:
  workflow_dispatch:
    inputs:
      ckpt:
        description: "Resume from checkpoint (optional, e.g. checkpoints/step_2000.pt)"
        required: false
        default: ""

jobs:
  train:
    runs-on: ubuntu-latest     
    timeout-minutes: 30        
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install deps (CPU)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # install CPU-only torch wheels
          pip uninstall -y torch torchvision torchaudio || true
          pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu

      - name: Train (CPU)
        env:
          CKPT: ${{ github.event.inputs.ckpt }}
        run: |
          set -e
          python -V
          if [ -n "$CKPT" ]; then
            python train.py --config configs/recommended.yaml --ckpt "$CKPT"
          else
            python train.py --config configs/recommended.yaml
          fi

      - name: Upload checkpoints
        uses: actions/upload-artifact@v4
        with:
          name: checkpoints
          path: checkpoints/
          retention-days: 7
